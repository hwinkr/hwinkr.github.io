{"componentChunkName":"component---src-templates-post-jsx","path":"/til-frontend-deploy/","result":{"data":{"site":{"siteMetadata":{"title":"HW.log"}},"markdownRemark":{"id":"648adad1-d36b-57c4-be02-c4fa564c53a3","excerpt":"모모 프론트엔드 배포 자동화 도전! 6주 동안 모모 서비스 개발을 진행하면서, 프론트엔드 작업이 배포가 되어야 하는 상황에 매번 aws에 로그인을 하고, s3 버킷에 새로운 리소스들을 업로드하고, cloudfront의 캐싱을 무효화 하는 작업을 수동으로 했었다. 더이상 이럴 수 없다는 생각이 들어 페드로와 함께 프론트엔드 배포 자동화를 진행했다. 아래는 …","html":"<h2 id=\"모모-프론트엔드-배포-자동화-도전\" style=\"position:relative;\"><a href=\"#%EB%AA%A8%EB%AA%A8-%ED%94%84%EB%A1%A0%ED%8A%B8%EC%97%94%EB%93%9C-%EB%B0%B0%ED%8F%AC-%EC%9E%90%EB%8F%99%ED%99%94-%EB%8F%84%EC%A0%84\" aria-label=\"모모 프론트엔드 배포 자동화 도전 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>모모 프론트엔드 배포 자동화 도전!</h2>\n<p>6주 동안 모모 서비스 개발을 진행하면서, 프론트엔드 작업이 배포가 되어야 하는 상황에 매번 aws에 로그인을 하고, s3 버킷에 새로운 리소스들을 업로드하고, cloudfront의 캐싱을 무효화 하는 작업을 수동으로 했었다. 더이상 이럴 수 없다는 생각이 들어 페드로와 함께 프론트엔드 배포 자동화를 진행했다. 아래는 배포를 자동화하기 위한 yml 파일을 설정하면서 배운 내용들이다!</p>\n<h3 id=\"프론트엔드-배포-yml-파일에서-사용되는-키워드\" style=\"position:relative;\"><a href=\"#%ED%94%84%EB%A1%A0%ED%8A%B8%EC%97%94%EB%93%9C-%EB%B0%B0%ED%8F%AC-yml-%ED%8C%8C%EC%9D%BC%EC%97%90%EC%84%9C-%EC%82%AC%EC%9A%A9%EB%90%98%EB%8A%94-%ED%82%A4%EC%9B%8C%EB%93%9C\" aria-label=\"프론트엔드 배포 yml 파일에서 사용되는 키워드 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>프론트엔드 배포 yml 파일에서 사용되는 키워드</h3>\n<ul>\n<li>github actions</li>\n<li>self-hosted</li>\n<li>aws s3, cloudfront</li>\n</ul>\n<h3 id=\"on\" style=\"position:relative;\"><a href=\"#on\" aria-label=\"on permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>on</h3>\n<p>develop 브랜치에서 시작해서</p>\n<ul>\n<li>새로운 기능(feature)를 구현하고,</li>\n<li>develop 브랜치로 PR(Pull Request)를 생성하고,</li>\n<li>코드 리뷰를 주고 받다가 develop 브랜치로 머지가 될 때 Frontend CD workflow를 실행한다.</li>\n</ul>\n<p>깃허브 이벤트에는 merge가 존재하지 않으므로, develop 브랜치에 push가 되었을 때 워크 플로우를 실행한다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">name: Frontend CD\n\non:\n  push:\n    branches: <span class=\"token punctuation\">[</span><span class=\"token string\">\"develop\"</span><span class=\"token punctuation\">]</span>\n\npermissions:\n  checks: <span class=\"token function\">write</span></code></pre></div>\n<h2 id=\"jobs\" style=\"position:relative;\"><a href=\"#jobs\" aria-label=\"jobs permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>jobs</h2>\n<h3 id=\"1-detect-changes\" style=\"position:relative;\"><a href=\"#1-detect-changes\" aria-label=\"1 detect changes permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>1) detect-changes</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">detect-changes:\n  runs-on: ubuntu-latest\n  permissions:\n    pull-requests: <span class=\"token builtin class-name\">read</span>\n  outputs:\n    backend: <span class=\"token variable\">${{ steps.filter.outputs.backend }</span><span class=\"token punctuation\">}</span>\n    frontend: <span class=\"token variable\">${{ steps.filter.outputs.frontend }</span><span class=\"token punctuation\">}</span>\n  steps:\n    - uses: actions/checkout@v4 <span class=\"token comment\"># Push 이벤트이기 때문에 checkout 해야 함</span>\n      with:\n        ref: develop\n    - uses: dorny/paths-filter@v3\n      id: filter\n      with:\n        base: <span class=\"token string\">\"develop\"</span> <span class=\"token comment\"># 해당 브랜치의 last commit과 변경점 비교</span>\n        filters: <span class=\"token operator\">|</span>\n          backend:\n            - <span class=\"token string\">'backend/**'</span>\n          frontend:\n            - <span class=\"token string\">'frontend/**'</span></code></pre></div>\n<p>백엔드의 PR이 머지되어 develop 브랜치에 push 이벤트가 발생할 경우에는 프론트엔드 CD 워크플로우가 실행될 필요가 없기 때문에, <code class=\"language-text\">detect-changes</code> job을 활용한다. <code class=\"language-text\">detect-change</code>는 <code class=\"language-text\">develop</code> 브랜치의 last commit과 PR에서의 backend, frontend 폴더 내부의 commit들과 비교해서 비교 결과를 outputs의 frontend, backend에 각각 담는 작업을 수행하는 job이다.</p>\n<h3 id=\"2-fe-build\" style=\"position:relative;\"><a href=\"#2-fe-build\" aria-label=\"2 fe build permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>2) fe-build</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">fe-build:\n  needs: detect-changes <span class=\"token comment\"># jobs들은 병렬로 실행됨, needs 키워드를 사용해서 특정 job이 완료(성공)면 실행하도록 설정</span>\n  if: <span class=\"token variable\">${{ needs.detect-changes.outputs.frontend == 'true' }</span><span class=\"token punctuation\">}</span>\n  runs-on: ubuntu-latest\n  defaults:\n    run:\n      shell: <span class=\"token function\">bash</span>\n      working-directory: ./frontend\n\n  steps:\n  - name: 모모 레파지토리의 코드를 가져와요 <span class=\"token builtin class-name\">:</span><span class=\"token punctuation\">)</span>\n    uses: actions/checkout@v4\n\n  - name: 노드 버젼을 설정해요 <span class=\"token builtin class-name\">:</span><span class=\"token punctuation\">)</span>\n    uses: actions/setup-node@v4\n    with:\n      node-version: <span class=\"token string\">\"lts/*\"</span>\n\n  - name: 이전 의존성을 저장해둔게 있나~? 확인해요 <span class=\"token builtin class-name\">:</span><span class=\"token punctuation\">)</span>\n    id: cache\n    uses: actions/cache@v4\n    with:\n      path: <span class=\"token string\">\"frontend/node_modules\"</span>\n      key: <span class=\"token variable\">${{ runner.os }</span><span class=\"token punctuation\">}</span>-node-<span class=\"token variable\">${{ hashFiles('**<span class=\"token operator\">/</span>package-lock.json') }</span><span class=\"token punctuation\">}</span>\n      restore-keys: <span class=\"token operator\">|</span>\n        <span class=\"token variable\">${{ runner.os }</span><span class=\"token punctuation\">}</span>-node-\n        <span class=\"token variable\">${{ runner.os }</span><span class=\"token punctuation\">}</span>\n\n  - name: package-lock.json을 활용해서 의존성을 깨끗하게 설치해요 <span class=\"token builtin class-name\">:</span><span class=\"token punctuation\">)</span>\n    if: steps.cache.outputs.cache-hit <span class=\"token operator\">!=</span> <span class=\"token string\">'true'</span>\n    run: <span class=\"token function\">npm</span> ci\n\n  - name: .env 파일을 생성해요 <span class=\"token builtin class-name\">:</span><span class=\"token punctuation\">)</span>\n    run: <span class=\"token operator\">|</span>\n      <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">${{ secrets.MOMO_FE_ENV }</span>}\"</span> <span class=\"token operator\">>></span> .env\n\n  - name: 프론트엔드 리소스를 빌드해요 <span class=\"token builtin class-name\">:</span><span class=\"token punctuation\">)</span>\n    run: <span class=\"token function\">npm</span> run build\n\n  - name: 프론트엔드 리소스 결과물을 깃허브 레파지토리 artifacts로 업로드해요\n    uses: actions/upload-artifact@v4\n    with:\n      name: momoResources\n      path: frontend/dist</code></pre></div>\n<p><strong>1) needs</strong></p>\n<p><strong>깃허브 워크플로우에서 각 job들은 병렬로(동시에) 실행</strong>되기 때문에, 만약 A job이 B job의 결과에 영향을 받는다면 A job에서 <code class=\"language-text\">needs</code>를 활용해서 B job이 끝나기를 기다려야 한다는 것을 명시한다. fe-build는 detect-change의 결과에 따라서 실행을 할지 말지 결정되기 때문에 needs에 detect-change를 추가한다. detect-change job의 결과물에서 frontend에 변경사항이 있으면, 프론트엔드 리소스들을 빌드하기 위한 job을 수행한다.</p>\n<p><strong>2) working-directory: ./frontend</strong></p>\n<p>workding-directory가 ./frontend라는 것은 워크플로우를 실행하는 깃허브 서버에서 <code class=\"language-text\">cd frontend</code> 명령어를 입력하는 것과 같다. npm ci, npm run build와 같은 명령어를 실행하려면 frontend 경로 내부에서 실행해야 하기 때문에 ./frontend경로로 이동해서 작업들을 수행할 것을 명시한다.</p>\n<p><strong>3) actions/checkout@v4</strong></p>\n<p>checkout은 깃허브 서버에 모모 레파지토리 코드를 가져오는 역할을 한다. 즉, 깃허브 서버에 git clone 명령어를 입력하는 것과 같다. checkout을 하면 워크플로우를 실행하는 깃허브 서버의 한 디렉터리에 모모 레파지토리 코드들이 다운로드된다. 100% 확실하지는 않은 경로지만 대략적으로 아래와 같이 디렉터리들이 만들어진다.</p>\n<ul>\n<li><code class=\"language-text\">/home/runner/work/2024-momo/frontend-cd/frontend</code></li>\n<li><code class=\"language-text\">/home/runner/work/2024-momo/frontend-cd/backend</code></li>\n</ul>\n<p><strong>4) upload-artifact</strong></p>\n<p>working-directory가 ./frontend이기 때문에 모모 레파지토리에 있는 frontend 디렉터리로 이동해서, 의존성(package.json)들을 설치하고, env 파일을 설정하고 npm run build를 실행한다. 빌드까지 완료되면 위에서 언급한 대략적인 디렉터리에 즉, <code class=\"language-text\">/home/runner/work/2024-momo/frontend-cd/frontend/dist</code> 해당 디렉터리에 빌드 결과물들이 생긴다. 이제 <code class=\"language-text\">artifacts</code>에 <code class=\"language-text\">frontend/dist</code> 경로에 있는 결과물을 임시저장한다. 깃허브 <code class=\"language-text\">artifacts</code>는 워크플로우 실행 중에 생성된 파일이나 결과물을 임시로 저장하고, 다른 워크플로우 단계에서 다운로드해서 사용할 수 있는 임시 저장소 역할을 한다.</p>\n<h3 id=\"3-deploy\" style=\"position:relative;\"><a href=\"#3-deploy\" aria-label=\"3 deploy permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>3) deploy</h3>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">deploy:\n  needs: fe-build\n  runs-on: self-hosted\n  env:\n    CLOUD_FRONT_DISTRIBUTION_ID: <span class=\"token variable\">${{ secrets.CLOUDFRONT_DISTRIBUTION_ID}</span><span class=\"token punctuation\">}</span>\n  steps:\n    - name: 모모 깃허브 레파지토리 artifacts로 부터 빌드 결과물을 다운받아요 <span class=\"token builtin class-name\">:</span><span class=\"token punctuation\">)</span>\n      uses: actions/download-artifact@v4\n      with:\n        name: momoResources\n        path: ./frontend/dist\n    - name: aws에 배포하고 cloudfront 캐싱을 무효화해요\n      working-directory: ./frontend/dist/\n      run: <span class=\"token operator\">|</span>\n        aws s3 <span class=\"token function\">sync</span> ./ s3://techcourse-project-2024/momo <span class=\"token parameter variable\">--delete</span>\n        aws cloudfront create-invalidation --distribution-id <span class=\"token string\">\"<span class=\"token variable\">$CLOUD_FRONT_DISTRIBUTION_ID</span>\"</span> <span class=\"token parameter variable\">--paths</span> <span class=\"token string\">\"/*\"</span></code></pre></div>\n<p><strong>1) self-hosted</strong></p>\n<p>깃허브 서버(ubunt-lastes)를 사용하는 것이 아니라, self-hosted를 사용하는 이유는 깃허브 서버에서 우아한테크코스 aws에 접근할 수 있는 방법이 없기 때문이다. IAM 키를 발급받을 수 없는 환경이기 때문에, 우아한테크코스 aws에서 생성한 EC2 인스턴스에서 deploy job을 실행해야 한다.</p>\n<p><code class=\"language-text\">aws s3 sync</code>, <code class=\"language-text\">aws cloudfront …</code> 와 같은 aws 명령어를 실행하기 위해서는 EC2 인스턴스에 <code class=\"language-text\">aws cli</code>가 설치되어 있어야 한다.</p>\n<p><strong>2) download-artifact</strong></p>\n<p>깃허브 artifacts에 저장한 momoResource를 EC2 인스턴스의 ./frontend/dist 경로에 다운로드 받는다. 깃허브 artifacts는 upload 할 때, 사용했던 name기준으로 찾는다.</p>\n<blockquote>\n<p><strong>*Downloading files</strong>: You can only download artifacts that were uploaded during the same workflow run. When you download a file, you can reference it by name.\n파일 다운로드: 동일한 워크플로 실행 중에 업로드된 아티팩트만 다운로드할 수 있습니다. 파일을 다운로드할 때 이름으로 파일을 참조할 수 있습니다.*</p>\n</blockquote>\n<p><a href=\"https://docs.github.com/en/actions/writing-workflows/choosing-what-your-workflow-does/storing-workflow-data-as-artifacts#about-workflow-artifacts\">참고</a></p>\n<p><strong>3) aws s3 sync</strong></p>\n<p>aws s3 sync는 자동으로 변경을 감지하여 변경 사항이 있는 파일들만 s3 버킷과 동기화 한다. 즉, 현재 s3 버킷에 저장되어 있는 리소스들과, 새롭게 빌드된 리소스들을 비교를 해서 변경 사항이 있는 파일들만 동기화 하는 작업을 수행한다.</p>\n<p><strong>4) aws cloudfront create-invalidation</strong></p>\n<p>cloudfront의 역할 중에는 s3 버킷에 저장된 리소스들을 캐싱하는 역할도 있다. 만약 s3 버킷에는 새로운 리소스들이 업로드 되어 있지만, cloudfront는 여전히 예전 리소스들을 캐싱하고 있다면 새로운 버젼이 릴리즈되었음에도 불구하고 사용자에게 이전 버젼의 서비스를 제공할 수도 있는 문제가 발생한다. 이 문제가 발생하지 않도록 하기 위해서 create-invalidation 명령어를 통해서 cloudfront의 캐싱을 무효화한다. 리액트 쿼리의 <code class=\"language-text\">queryClient.invalidateQueries</code> 와 비슷하다.</p>\n<p>아래는 전체 yml 파일 구성이다.</p>\n<div class=\"gatsby-highlight\" data-language=\"shell\"><pre class=\"language-shell\"><code class=\"language-shell\">name: 모모 프론트엔드 배포 자동화 워크플로우\n\non:\n  push:\n    branches: <span class=\"token punctuation\">[</span><span class=\"token string\">\"develop\"</span><span class=\"token punctuation\">]</span>\n\npermissions:\n  checks: <span class=\"token function\">write</span>\n\njobs:\n  detect-changes:\n    runs-on: ubuntu-latest\n    permissions:\n      pull-requests: <span class=\"token builtin class-name\">read</span>\n    outputs:\n      backend: <span class=\"token variable\">${{ steps.filter.outputs.backend }</span><span class=\"token punctuation\">}</span>\n      frontend: <span class=\"token variable\">${{ steps.filter.outputs.frontend }</span><span class=\"token punctuation\">}</span>\n    steps:\n      - uses: actions/checkout@v4 <span class=\"token comment\"># Push 이벤트이기 때문에 checkout 해야 함</span>\n        with:\n          ref: develop\n      - uses: dorny/paths-filter@v3\n        id: filter\n        with:\n          base: <span class=\"token string\">\"develop\"</span> <span class=\"token comment\"># 해당 브랜치의 last commit과 변경점 비교</span>\n          filters: <span class=\"token operator\">|</span>\n            backend:\n              - <span class=\"token string\">'backend/**'</span>\n            frontend:\n              - <span class=\"token string\">'frontend/**'</span>\n\n  fe-build:\n    needs: detect-changes <span class=\"token comment\"># jobs들은 병렬로 실행됨, needs 키워드를 사용해서 특정 job이 완료(성공)면 실행하도록 설정</span>\n    if: <span class=\"token variable\">${{ needs.detect-changes.outputs.frontend == 'true' }</span><span class=\"token punctuation\">}</span>\n    runs-on: ubuntu-latest\n    defaults:\n      run:\n        shell: <span class=\"token function\">bash</span>\n        working-directory: ./frontend\n\n    steps:\n      - name: 모모 레파지토리의 코드를 가져와요 <span class=\"token builtin class-name\">:</span><span class=\"token punctuation\">)</span>\n        uses: actions/checkout@v4\n\n      - name: 노드 버젼을 설정해요 <span class=\"token builtin class-name\">:</span><span class=\"token punctuation\">)</span>\n        uses: actions/setup-node@v4\n        with:\n          node-version: <span class=\"token string\">\"lts/*\"</span>\n\n      - name: 이전 의존성을 저장해둔게 있나~? 확인해요 <span class=\"token builtin class-name\">:</span><span class=\"token punctuation\">)</span>\n        id: cache\n        uses: actions/cache@v4\n        with:\n          path: <span class=\"token string\">\"frontend/node_modules\"</span>\n          key: <span class=\"token variable\">${{ runner.os }</span><span class=\"token punctuation\">}</span>-node-<span class=\"token variable\">${{ hashFiles('**<span class=\"token operator\">/</span>package-lock.json') }</span><span class=\"token punctuation\">}</span>\n          restore-keys: <span class=\"token operator\">|</span>\n            <span class=\"token variable\">${{ runner.os }</span><span class=\"token punctuation\">}</span>-node-\n            <span class=\"token variable\">${{ runner.os }</span><span class=\"token punctuation\">}</span>\n\n      - name: package-lock.json을 활용해서 의존성을 깨끗하게 설치해요 <span class=\"token builtin class-name\">:</span><span class=\"token punctuation\">)</span>\n        if: steps.cache.outputs.cache-hit <span class=\"token operator\">!=</span> <span class=\"token string\">'true'</span>\n        run: <span class=\"token function\">npm</span> ci\n\n      - name: .env 파일을 생성해요 <span class=\"token builtin class-name\">:</span><span class=\"token punctuation\">)</span>\n        run: <span class=\"token operator\">|</span>\n          <span class=\"token builtin class-name\">echo</span> <span class=\"token string\">\"<span class=\"token variable\">${{ secrets.MOMO_FE_ENV }</span>}\"</span> <span class=\"token operator\">>></span> .env\n\n      - name: 프론트엔드 리소스를 빌드해요 <span class=\"token builtin class-name\">:</span><span class=\"token punctuation\">)</span>\n        run: <span class=\"token function\">npm</span> run build\n\n      - name: 프론트엔드 리소스 결과물을 깃허브 레파지토리 artifacts로 업로드해요\n        uses: actions/upload-artifact@v4\n        with:\n          name: momoResources\n          path: frontend/dist\n\n  deploy:\n    needs: fe-build\n    runs-on: self-hosted\n    env:\n      CLOUD_FRONT_DISTRIBUTION_ID: <span class=\"token variable\">${{ secrets.CLOUDFRONT_DISTRIBUTION_ID}</span><span class=\"token punctuation\">}</span>\n    steps:\n      - name: 모모 깃허브 레파지토리 artifacts로 부터 빌드 결과물을 다운받아요 <span class=\"token builtin class-name\">:</span><span class=\"token punctuation\">)</span>\n        uses: actions/download-artifact@v4\n        with:\n          name: momoResources\n          path: ./frontend/dist\n      - name: aws에 배포하고 cloudfront 캐싱을 무효화해요\n        working-directory: ./frontend/dist/\n        run: <span class=\"token operator\">|</span>\n          aws s3 <span class=\"token function\">sync</span> ./ s3://techcourse-project-2024/momo <span class=\"token parameter variable\">--delete</span>\n          aws cloudfront create-invalidation --distribution-id <span class=\"token string\">\"<span class=\"token variable\">$CLOUD_FRONT_DISTRIBUTION_ID</span>\"</span> <span class=\"token parameter variable\">--paths</span> <span class=\"token string\">\"/*\"</span></code></pre></div>\n<h2 id=\"느낀점\" style=\"position:relative;\"><a href=\"#%EB%8A%90%EB%82%80%EC%A0%90\" aria-label=\"느낀점 permalink\" class=\"heading-anchor before\"><svg xmlns=\"http://www.w3.org/2000/svg\" width=\"15\" height=\"15\" viewBox=\"0 0 24 24\"><path d=\"M6.188 8.719c.439-.439.926-.801 1.444-1.087 2.887-1.591 6.589-.745 8.445 2.069l-2.246 2.245c-.644-1.469-2.243-2.305-3.834-1.949-.599.134-1.168.433-1.633.898l-4.304 4.306c-1.307 1.307-1.307 3.433 0 4.74 1.307 1.307 3.433 1.307 4.74 0l1.327-1.327c1.207.479 2.501.67 3.779.575l-2.929 2.929c-2.511 2.511-6.582 2.511-9.093 0s-2.511-6.582 0-9.093l4.304-4.306zm6.836-6.836l-2.929 2.929c1.277-.096 2.572.096 3.779.574l1.326-1.326c1.307-1.307 3.433-1.307 4.74 0 1.307 1.307 1.307 3.433 0 4.74l-4.305 4.305c-1.311 1.311-3.44 1.3-4.74 0-.303-.303-.564-.68-.727-1.051l-2.246 2.245c.236.358.481.667.796.982.812.812 1.846 1.417 3.036 1.704 1.542.371 3.194.166 4.613-.617.518-.286 1.005-.648 1.444-1.087l4.304-4.305c2.512-2.511 2.512-6.582.001-9.093-2.511-2.51-6.581-2.51-9.092 0z\"/></svg></a>느낀점</h2>\n<p>이전에 <code class=\"language-text\">aws amplify</code>를 사용해서 배포를 했었을 때는, aws에서 알려주는대로 버튼만 클릭하면 알아서 모든 것을 해줬다. 심지어 yml 파일을 만들 필요도 없었다. 하지만 이번에 배포 자동화를 위한 yml 파일을 직접 만들면서 초반에는 이해하기 힘들었지만, 각 job들을 수행하기 위한 명령어들을 평소에 내가 자주 사용하는 명령어로 비유해서 이해를 시도하니 쉽게 이해할 수 있었다. (cd frontend, git clone과 같은…)</p>\n<p>이제 merge 버튼만 클릭하면 프론트엔드 배포가 알아서 된다니… 너무 편하게 개발할 수 있을 것 같다!</p>\n<ul>\n<li>PR 링크 : <a href=\"https://github.com/woowacourse-teams/2024-momo/pull/212\">https://github.com/woowacourse-teams/2024-momo/pull/212</a></li>\n</ul>","frontmatter":{"title":"[TIL] aws s3, cloudfront 배포 자동화 해보기","date":"August 12, 2024","update":"August 12, 2024","tags":["TIL","우아한테크코스"],"series":"TIL"},"fields":{"slug":"til-frontend-deploy","readingTime":{"minutes":12.58}}},"seriesList":{"edges":[{"node":{"id":"648adad1-d36b-57c4-be02-c4fa564c53a3","fields":{"slug":"til-frontend-deploy"},"frontmatter":{"title":"[TIL] aws s3, cloudfront 배포 자동화 해보기"}}}]},"previous":{"fields":{"slug":"woowacourse-level-3-3th-sprint-retrospect"},"frontmatter":{"title":"우아한테크코스 레벨 3 2차 스프린트 회고"}},"next":null},"pageContext":{"id":"648adad1-d36b-57c4-be02-c4fa564c53a3","series":"TIL","previousPostId":"e7b23005-dd71-5b80-bfb9-23a07f24b8ee","nextPostId":null}},"staticQueryHashes":[],"slicesMap":{}}